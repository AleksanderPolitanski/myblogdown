---
title: "Analizy zachorowań na Covid19"
date: 2020-04-02
categories: ["R"]
tags: ["R Markdown", "plot", "regression"]
fig_height: 4
fig_width: 6

---
###Analizy na podstawie danych z 01 kwietnia



```{r, include=FALSE}
library(dplyr)
library(openxlsx)
library(ggplot2)
library(ggrepel)
library(knitr)

options(scipen=999)

path<-"C:/Users/Admin/Desktop/COVID/2 kw/"

data<-read.xlsx(paste0(path,"COVID-19-geographic-disbtribution-worldwide-2020-04-02.xlsx"), detectDates = TRUE)
names(data)<-c("DateRep", "Day", "Month", "Year", "Cases", "Deaths", "Countries.and.territories", "GeoId", "Country.Code", "Pop_Data.2018")

data_without_0<-data[data$Cases!=0 & data$Cases!=-9,]

data_without_0$ranks<-""

data_without_0[data_without_0$Countries.and.territories=="CANADA" & is.na(data_without_0$Countries.and.territories)==FALSE,"Countries.and.territories"]<-"Canada"


for (country in data_without_0$Countries.and.territories){
  data_without_0[data_without_0$Countries.and.territories==country,"ranks"]<-rank(data_without_0[data_without_0$Countries.and.territories==country,"DateRep"])
}

data_without_0$PolskaVsSwiat<-ifelse(test = data_without_0$Countries.and.territories=="Poland", yes = "Poland", no = "Rest of the world")

kontynenty<-read.xlsx(paste0(path,"Kontynenty.xlsx"))

data_without_0<-data_without_0 %>% left_join(kontynenty, by = c("Countries.and.territories"="Kraj"))

unique(data_without_0[is.na(data_without_0$Kontynent)==TRUE,"Countries.and.territories"])
# unique(data_without_0$Countries.and.territories)

data_GDP<-read.xlsx(paste0(path,"GDB per capita.xlsx"), sheet = 1)

data_without_0<-data_without_0 %>%
  left_join(data_GDP, by = c("Country.Code"="Country.Code"))


# Cases per million

data_without_0$Cases_per_million<-data_without_0$Cases/(data_without_0$Pop_Data.2018/1000000)

data_without_0<-data_without_0[is.na(data_without_0$Cases_per_million)==FALSE,]

pol_n<-max(as.numeric(data_without_0[data_without_0$Countries.and.territories=="Poland","ranks"]))


# Poland vs rest of the world


populations<-data_without_0 %>% 
  select(Pop_Data.2018,Countries.and.territories,PolskaVsSwiat,ranks) %>%
  distinct()

agg_populations<-populations %>%
  select(PolskaVsSwiat,Pop_Data.2018,ranks) %>%
  group_by(PolskaVsSwiat,ranks) %>%
  summarise(Pop_Data.2018=sum(Pop_Data.2018) )
  
agg_cases<-data_without_0 %>% 
  select(PolskaVsSwiat,Cases,ranks) %>%
  group_by(PolskaVsSwiat,ranks) %>%
  summarise(Cases=sum(Cases) )
  
  
agg_pol_rest<-agg_cases %>% 
  left_join(agg_populations) %>%
  mutate(Cases_per_million=Cases/(Pop_Data.2018/1000000) )
  
  
agg_pol_rest$ranks<-factor(x = agg_pol_rest$ranks, levels = c(1:max(as.numeric(agg_pol_rest$ranks))))


cols <- c ("blue")
names(cols)<-unique(agg_pol_rest[agg_pol_rest$PolskaVsSwiat!="Poland","PolskaVsSwiat"])
cols <- c(cols, "Poland"="red")


p1<-ggplot(data = agg_pol_rest, aes(x = ranks, y = Cases_per_million, color = PolskaVsSwiat, group = PolskaVsSwiat)) + 
  geom_line(size=1.2) +
  geom_point(size=1.5) +
  labs(x = "Dni epidemii", y = "Zachorowania per milion") +
  scale_y_continuous(breaks = seq(0,max(agg_pol_rest$Cases_per_million),1), limits = c(0,max(agg_pol_rest$Cases_per_million))) +
  scale_x_discrete(breaks = seq(0,max(as.numeric(agg_pol_rest$ranks)),10) ) +
  theme(axis.text.x = element_text(angle = 45,colour = "black"), 
    axis.text.y = element_text(colour = "black"), 
    legend.title = element_blank(),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 16),
    panel.background = element_rect(fill = "white") ) +
  scale_colour_manual(values = cols)



# Continents

populations2<-data_without_0 %>% 
  select(Pop_Data.2018,Countries.and.territories,Kontynent,ranks) %>%
  distinct()

agg_populations2<-populations2 %>%
  select(Kontynent,Pop_Data.2018,ranks) %>%
  group_by(Kontynent,ranks) %>%
  summarise(Pop_Data.2018=sum(Pop_Data.2018) )
  
agg_cases2<-data_without_0 %>% 
  select(Kontynent,Cases,ranks) %>%
  group_by(Kontynent,ranks) %>%
  summarise(Cases=sum(Cases) )
  
  
agg_continents<-agg_cases2 %>% 
  filter(Kontynent != "Other") %>% 
  left_join(agg_populations2) %>%
  mutate(Cases_per_million=Cases/(Pop_Data.2018/1000000) )
  

agg_continents<-agg_continents[agg_continents$Kontynent != "Not important" & is.na(agg_continents$Kontynent)==FALSE,]

cols <- c ("blue","black","brown","green","orange")
ncols<-unique(agg_continents$Kontynent)
ncols<-ncols[!ncols=="Europe"]
names(cols)<-ncols
cols <- c(cols, "Europe"="red")

agg_continents$ranks<-factor(x = agg_continents$ranks, levels = c(1:max(as.numeric(agg_continents$ranks))))

p2<-ggplot(data = agg_continents, aes(x = ranks, y = Cases_per_million, color = Kontynent, group = Kontynent)) + 
  geom_line(size=1.2) +
  geom_point(size=1.5) +
  labs(x = "Dni epidemii", y = "Zachorowania per milion") +
  scale_y_continuous(breaks = seq(0,max(agg_continents$Cases_per_million),10), limits = c(0,max(agg_continents$Cases_per_million)) ) +
  scale_x_discrete(breaks = seq(0,max(as.numeric(agg_continents$ranks)),10) ) +
  theme(axis.text.x = element_text(angle = 45,colour = "black"), 
    axis.text.y = element_text(colour = "black"), 
    legend.title = element_blank(),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 16),
    panel.background = element_rect(fill = "white") ) +
  scale_colour_manual(values = cols)




# Poland vs top 5 countries

agg_countries<-data_without_0[data_without_0$Pop_Data.2018>2000000,] %>% 
  select(Cases_per_million,Countries.and.territories) %>%
  group_by(Countries.and.territories) %>%
  summarise(Cases_per_million=sum(Cases_per_million))

top_countries<-top_n(x = agg_countries, n = 5, wt = Cases_per_million)

agg_countries_top<- data_without_0[(data_without_0$Countries.and.territories %in% top_countries$Countries.and.territories) | data_without_0$Countries.and.territories == "Poland" ,] %>%
  select(Cases_per_million,ranks,Countries.and.territories) 

agg_countries_top$ranks<-factor(x = agg_countries_top$ranks, levels = c(1:max(as.numeric(agg_countries_top$ranks))))


cols <- c ("blue","black","brown","green","orange")
names(cols)<-unique(agg_countries_top[agg_countries_top$Countries.and.territories!="Poland","Countries.and.territories"])
cols <- c(cols, "Poland"="red")


p3<-ggplot(data = agg_countries_top, aes(x = ranks, y = Cases_per_million, color = Countries.and.territories, group = Countries.and.territories)) + 
  geom_line(size=1.2) +
  geom_point(size=1.5) +
  labs(x = "Dni epidemii", y = "Zachorowania per milion") +
  scale_y_continuous(breaks = seq(0,max(agg_countries_top$Cases_per_million),10), limits = c(0,max(agg_countries_top$Cases_per_million)) ) +
  scale_x_discrete(breaks = seq(0,max(as.numeric(agg_countries_top$ranks)),10) ) +
  theme(axis.text.x = element_text(angle = 45,colour = "black"), 
    axis.text.y = element_text(colour = "black"), 
    legend.title = element_blank(),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 16),
    panel.background = element_rect(fill = "white") ) +
  scale_colour_manual(values = cols)



# Poland vs bottom 5 countries


agg_countries_for_bottom<-data_without_0[data_without_0$Pop_Data.2018>2000000,] %>% 
  select(ranks,Countries.and.territories) %>%
  transmute(Countries.and.territories, ranks=as.numeric(ranks)) %>% 
  group_by(Countries.and.territories) %>%
  summarise(ranks_max=max(ranks))


bottom_candidates<-agg_countries_for_bottom$Countries.and.territories[agg_countries_for_bottom$ranks_max>=pol_n]


agg_bottom<-data_without_0[data_without_0$Countries.and.territories %in% bottom_candidates,] %>% 
  select(Cases_per_million,Countries.and.territories) %>%
  group_by(Countries.and.territories) %>%
  summarise(Cases_per_million=sum(Cases_per_million))

bottom_countries<-top_n(x = agg_bottom, n = 5, wt = -Cases_per_million)


agg_countries_bottom<- data_without_0[(data_without_0$Countries.and.territories %in% bottom_countries$Countries.and.territories) | data_without_0$Countries.and.territories == "Poland" ,] %>%
  select(Cases_per_million,ranks,Countries.and.territories)

agg_countries_bottom$ranks<-factor(x = agg_countries_bottom$ranks, levels = c(1:max(as.numeric(agg_countries_bottom$ranks))))



cols <- c ("blue","black","brown","green","orange")
names(cols)<-unique(agg_countries_bottom[agg_countries_bottom$Countries.and.territories!="Poland","Countries.and.territories"])
cols <- c(cols, "Poland"="red")

p4<-ggplot(data = agg_countries_bottom, aes(x = ranks, y = Cases_per_million, color = Countries.and.territories, group = Countries.and.territories)) + 
  geom_line(size=1.2) +
  geom_point(size=1.5) +
  labs(x = "Dni epidemii", y = "Zachorowania per milion") +
  scale_y_continuous(breaks = seq(0,max(agg_countries_bottom$Cases_per_million),1), limits = c(0,max(agg_countries_bottom$Cases_per_million)) ) +
  scale_x_discrete(breaks = seq(0,max(as.numeric(agg_countries_bottom$ranks)),10) ) +
  theme(axis.text.x = element_text(angle = 45,colour = "black"), 
    axis.text.y = element_text(colour = "black"), 
    legend.title = element_blank(),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 16),
    panel.background = element_rect(fill = "white") ) +
  scale_colour_manual(values = cols)



# Poland vs top 5 in Eastern Europe

agg_eastern<- data_without_0[data_without_0$Subkontynent == "Eastern Europe" & is.na(data_without_0$Subkontynent)==FALSE,] %>%
  select(Cases_per_million,ranks,Countries.and.territories)


agg_east_countries<-agg_eastern %>% 
  select(Cases_per_million,Countries.and.territories) %>%
  group_by(Countries.and.territories) %>%
  summarise(Cases_per_million=sum(Cases_per_million))

top_east_countries<-top_n(x = agg_east_countries, n = 5, wt = Cases_per_million)

agg_east_countries_top<- agg_eastern[(agg_eastern$Countries.and.territories %in% top_east_countries$Countries.and.territories) | agg_eastern$Countries.and.territories == "Poland" ,] %>%
  select(Cases_per_million,ranks,Countries.and.territories) 

agg_east_countries_top$ranks<-factor(x = agg_east_countries_top$ranks, levels = c(1:max(as.numeric(agg_east_countries_top$ranks))))


cols <- c ("blue","black","brown","green","orange")
names(cols)<-unique(agg_east_countries_top[agg_east_countries_top$Countries.and.territories!="Poland","Countries.and.territories"])
cols <- c(cols, "Poland"="red")



agg_east_countries_top$ranks<-factor(x = agg_east_countries_top$ranks, levels = c(1:max(as.numeric(agg_east_countries_top$ranks))))

p5<-ggplot(data = agg_east_countries_top, aes(x = ranks, y = Cases_per_million, color = Countries.and.territories, group = Countries.and.territories)) + 
  geom_line(size=1.2) +
  geom_point(size=1.5) +
  labs(x = "Dni epidemii", y = "Zachorowania per milion") +
  scale_y_continuous(breaks = seq(0,max(agg_east_countries_top$Cases_per_million),10), limits = c(0,max(agg_east_countries_top$Cases_per_million)) ) +
  scale_x_discrete(breaks = seq(0,max(as.numeric(agg_east_countries_top$ranks)),10) ) +
  theme(axis.text.x = element_text(angle = 45,colour = "black"), 
    axis.text.y = element_text(colour = "black"), 
    legend.title = element_blank(),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 16),
    panel.background = element_rect(fill = "white") ) +
  scale_colour_manual(values = cols)


agg_east_countries$ranking <- rank(x = -agg_east_countries$Cases_per_million)
pol_east_rank<-as.numeric(agg_east_countries[agg_east_countries$Countries.and.territories=="Poland","ranking"])
max_east_rank<-length(agg_east_countries$Countries.and.territories)


# GDP per capita by cases per million

agg_gdp<-data_without_0 %>% 
  filter(is.na(GDP.per.capita.in.Dollars)==FALSE ) %>%
  select(GDP.per.capita.in.Dollars,Countries.and.territories,Cases_per_million,Pop_Data.2018,Kontynent) %>%
  group_by(Countries.and.territories) %>%
  summarise(GDP.per.capita.in.Dollars=mean(GDP.per.capita.in.Dollars),
    Cases_per_million=sum(Cases_per_million),
    PopulationInMillions=mean(Pop_Data.2018)/1000000,
    Kontynent=unique(Kontynent))


cols <- c ("blue","black","brown","green","orange")
ncols<-unique(agg_continents$Kontynent)
ncols<-ncols[!ncols=="Europe"]
names(cols)<-ncols
cols <- c(cols, "Europe"="red")


chosen_countries<-c("Switzerland","Poland","China","United_States_of_America","India","Italy")
agg_gdp_chosen_countries<-subset(agg_gdp, Countries.and.territories %in% chosen_countries)


p6<-ggplot(agg_gdp, aes(x= GDP.per.capita.in.Dollars, y=Cases_per_million)) +
  geom_point(aes(color=Kontynent, size=PopulationInMillions)) + 
  geom_label_repel(data=agg_gdp_chosen_countries, 
    aes(label = Countries.and.territories),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = 'grey50') +
  scale_y_continuous(trans = "log10") +
  scale_colour_manual(values = cols) +
  labs(x = "PKB per capita w Dolarach", y = "Zachorowania per milion") +
  theme(
    axis.text.x = element_text(colour = "black"), 
    axis.text.y = element_text(colour = "black"), 
    legend.title = element_blank(),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 16),
    panel.background = element_rect(fill = "white") ) +
  scale_size(range = c(1, 8),guide=FALSE)



# GDP per capita by cases per million Europe

agg_eu_gdp<-data_without_0 %>% 
  filter(is.na(GDP.per.capita.in.Dollars)==FALSE & Kontynent=="Europe") %>%
  select(GDP.per.capita.in.Dollars,Countries.and.territories,Cases_per_million,Pop_Data.2018,Subkontynent) %>%
  group_by(Countries.and.territories) %>%
  summarise(GDP.per.capita.in.Dollars=mean(GDP.per.capita.in.Dollars),
    Cases_per_million=sum(Cases_per_million),
    PopulationInMillions=mean(Pop_Data.2018)/1000000,
    Subkontynent=unique(Subkontynent))



chosen_eu_countries<-c("Switzerland","Poland","Italy","Germany","Russia","Luxembourg","Spain")
agg_eu_gdp_chosen_countries<-subset(agg_eu_gdp, Countries.and.territories %in% chosen_eu_countries)


p7<-ggplot(agg_eu_gdp, aes(x= GDP.per.capita.in.Dollars, y=Cases_per_million)) +
  geom_point(aes(color=Subkontynent, size=PopulationInMillions)) + 
  geom_label_repel(data=agg_eu_gdp_chosen_countries, 
    aes(label = Countries.and.territories),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = 'grey50') +
  scale_y_continuous(trans = "log10") +
  scale_colour_manual(values = c("Eastern Europe"="Red", "Western Europe"="Blue")) +
  labs(x = "PKB per capita w Dolarach", y = "Zachorowania per milion") +
  theme(
    axis.text.x = element_text(colour = "black"), 
    axis.text.y = element_text(colour = "black"), 
    legend.title = element_blank(),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 16),
    panel.background = element_rect(fill = "white") ) +
  scale_size(range = c(1, 8),guide=FALSE)

```

##Polska na tle reszty świata
Poniższy wykres przedstawia stytystyki zachorowań na Covid-19 w przeliczeniu na milion mieszkańców, na przestrzeni kolejnych dni trwania epidemii. Pierwszy dzień epidemii jest pierwszym dniem, w którym odnotowano zachorowanie (dla Polski jest to inna data niż dla reszty świata). Średnia zachorowań dla świata jest wyliczona tylko dla krajów, w których wystąpiło dotąd przynajmniej jedno zachorowanie. 

```{r echo = FALSE, warning=FALSE}
plot(p1, echo = FALSE)
```


Z powyższych danych wynika, że sytuacja w Polsce jest średnio gorsza niż na świecie. 
Dane światowe są jednak bardzo zróżnicowane, co pokażą kolejne wykresy. Europa radzi sobie z epidemią znacznie gorzej niż chociażby Azja, co może częściowo tłumaczyć niekorzystne statystyki Polski na tle całej reszty świata. Wczoraj - `r Sys.Date()-1` - w Polsce zachorowało `r data_without_0[data_without_0$PolskaVsSwiat=="Poland" & data_without_0$ranks==as.character(pol_n), "Cases"]`  osób, co w liczbie na milion mieszkańców  przekłada się na wartość `r round(as.numeric(agg_pol_rest[agg_pol_rest$PolskaVsSwiat=="Poland" & agg_pol_rest$ranks==as.character(pol_n),"Cases_per_million"]),2)`. 


##Porównanie sytuacji na kontynentach
Logika poniższego wykresu jest identyczna z poprzednim. Zachorowania na milion mieszkańców, na przestrzeni kolejnych dni trwania epidemii. Tym razem w podziale na kontynenty. 

```{r echo = FALSE, warning=FALSE}
plot(p2, echo = FALSE)
```

Sytuacja w Azji wygląda na opanowaną. Niepokojąca tendencja wzrostu przypadków zachorowań pojawiła się w Ameryce Północnej. Europa pozostaje epicentrum pandemii.

##Polska na tle pięciu krajów o najwyższej średniej zachorowań na milion mieszkańców
Logika wykresu pozostaje ta sama. Kraje wybrano spośród tych, których populacja była większa niż 2 miliony mieszkańców, żeby uniknąć porównania z bardzo małymi państwami o całkowicie innej specyfice, na przykład Wyspami Owczymi, gdzie zanotowano bardzo wysokie wskaźniki zachorowań.
```{r echo = FALSE, warning=FALSE}
plot(p3, echo = FALSE)
```
Sytuacja w Polsce na tle tych państw wygląda obiecująco.

##Polska na tle pięciu krajów o najniższej średniej zachorowań na milion mieszkańców
Do porównania wybrano tylko te kraje, których populacja była większa niż 2 miliony mieszkańców a oprócz tego epidemia trwała w nich conajmniej tak długo jak w Polsce.
```{r echo = FALSE, warning=FALSE}
plot(p4, echo = FALSE)
```
Kwestią otwartą pozostaje pytanie dlaczego te państwa notują znacznie mniej zachorowań niż Polska w przeliczeniu na milion mieszkańców. Czy jest to efekt prowadzonej polityki (Azja?), a może w danych krajach prowadzi się znacznie mniej testów? 

## Polska na tle pięciu krajów o najwyższej średniej zachorowań na milion mieszkańców w regionie Europy Wschodniej (i Środkowo-Wschodniej)
Pod względem liczby zachorowań na milion mieszkańców, Polska znajduje się na `r pol_east_rank` miejscu z `r max_east_rank`. Innymi słowy `r max_east_rank-(max_east_rank-pol_east_rank)-1` krajów regionu ma wyższe wskaźniki zachorowań niż Polska. 
```{r echo = FALSE, warning=FALSE}
plot(p5, echo = FALSE)
```

## Zachorowania na milion mieszkańców a PKB per capita
Koronawirus atakuje na razie najmocniej kraje bogate. Na ogół, im kraj jest bogatszy, tym więcej w nim zachorowań na milion mieszkańców. Znaczną większość krajów bogatych, najbardziej cierpiących z powodu pandemii, stanowią kraje Europejskie. Zwracam uwagę na skalę wykresu, która tym razem jest logarytmiczna (wartości nie rosną liniowo). 
```{r echo = FALSE, warning=FALSE}
plot(p6, echo = FALSE)
```
Jak na względnie bogaty kraj, Polska wygląda w tym zestawieniu korzystnie pod względem średniej liczby zachorowań na milion mieszkańców. Następnym razem sprawdzę jak wygląda to samo zestawienie w samej Europie, z zaznaczeniem krajów Zachodnich i Wschodnich.

## Zachorowania na milion mieszkańców a PKB per capita w Europie
Ten sam wykres co wyżej dla Europy, w podziale na subregiony
```{r echo = FALSE, warning=FALSE}
plot(p7, echo = FALSE)
```

******

*[Źródło danych 1](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide)

*[Źródło danych 2](https://data.worldbank.org/indicator/NY.GDP.PCAP.PP.CD)
